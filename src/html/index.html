<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gurukul Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default theme color, will be overridden by the config sheet */
            --primary-color: #f97316; 
            --primary-color-darker: #ea580c;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
        .item-row:hover {
            background-color: #f9fafb;
        }
        /* Modal styles */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }

        /* Classes using the dynamic theme color */
        .primary-text { color: var(--primary-color); }
        .primary-bg { background-color: var(--primary-color); }
        .primary-bg:hover { background-color: var(--primary-color-darker); }
        .primary-ring-focus:focus { --tw-ring-color: var(--primary-color); }

        .tab-button.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        .tab-button {
             border-bottom-width: 4px;
             border-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-4xl p-4">
        <!-- Header -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6 text-center">
            <h1 id="header-title" class="text-3xl font-bold primary-text">Shree Swaminarayan Gurukul Nikol</h1>
            <p class="text-xl text-gray-600 mt-2">Food Supply Inventory</p>
        </header>

        <!-- Main Content with Tabs -->
        <main class="bg-white shadow-md rounded-lg">
            <!-- Tab Buttons -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex gap-6 px-6">
                    <button onclick="changeTab('inventory')" class="tab-button active py-4 px-1 font-medium text-lg">Inventory</button>
                    <button onclick="changeTab('menu')" class="tab-button py-4 px-1 font-medium text-lg text-gray-500 hover:text-[var(--primary-color)] hover:border-gray-300">Menu</button>
                    <button onclick="changeTab('report')" class="tab-button py-4 px-1 font-medium text-lg text-gray-500 hover:text-[var(--primary-color)] hover:border-gray-300">Daily Report</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- INVENTORY TAB -->
                <div id="inventory-tab">
                    <div id="loading" class="text-center py-8">
                        <p class="text-gray-500">Loading inventory...</p>
                    </div>
                    <div id="inventory-list" class="hidden"></div>
                    <div id="error" class="hidden text-center py-8">
                        <p class="text-red-500">Failed to load inventory. Please try again later.</p>
                    </div>
                    <div class="mt-8 pt-6 border-t">
                        <h2 class="text-2xl font-semibold mb-4">Add New Inventory Item</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input id="newItemName" type="text" placeholder="Item Name (e.g., Rice)" class="flex-grow p-3 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus">
                            <select id="newItemUnit" class="w-full sm:w-40 p-3 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus">
                                <option value="kg">kg</option>
                                <option value="g">g</option>
                                <option value="pcs">pcs</option>
                                <option value="litre">litre</option>
                            </select>
                            <button id="addItemBtn" class="primary-bg text-white font-semibold py-3 px-6 rounded-lg transition duration-300">Add Item</button>
                        </div>
                        <p id="add-item-status" class="text-center mt-4 text-sm"></p>
                    </div>
                </div>

                <!-- MENU TAB -->
                <div id="menu-tab" class="hidden">
                    <h2 class="text-2xl font-semibold mb-4">Menu & Recipe Management</h2>
                    <div class="space-y-6 bg-gray-50 p-6 rounded-lg border">
                        <div>
                             <label for="menu-item-name" class="block text-sm font-medium text-gray-700">New Menu Item Name</label>
                             <input type="text" id="menu-item-name" placeholder="e.g., Dal Fry" class="mt-1 w-full p-2 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus">
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Ingredients</h3>
                            <div id="ingredients-container" class="mt-2 space-y-2"></div>
                            <button onclick="addIngredientRow()" class="mt-2 text-sm font-semibold primary-text hover:text-[var(--primary-color-darker)]">+ Add Ingredient</button>
                        </div>
                        <div class="text-center">
                            <button id="saveRecipeBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 w-full sm:w-auto">Save New Menu Item</button>
                            <p id="recipe-status" class="text-center mt-4 text-sm"></p>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t">
                        <h3 class="text-xl font-semibold">Existing Menu Items</h3>
                        <div id="existing-recipes" class="mt-4 space-y-2">Loading...</div>
                    </div>
                </div>

                <!-- DAILY REPORT TAB -->
                <div id="report-tab" class="hidden">
                    <h2 class="text-2xl font-semibold mb-4">Log Daily Menu & Waste</h2>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="report-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="report-date" class="mt-1 w-full p-2 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus">
                            </div>
                            <div>
                                <label for="report-meal" class="block text-sm font-medium text-gray-700">Meal</label>
                                <select id="report-meal" class="mt-1 w-full p-2 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus">
                                    <option>Breakfast</option> <option>Lunch</option> <option>Dinner</option>
                                </select>
                            </div>
                            <div>
                                <label for="report-people" class="block text-sm font-medium text-gray-700">People Served</label>
                                <input type="number" id="report-people" placeholder="e.g., 150" class="mt-1 w-full p-2 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus">
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Menu Items Cooked</h3>
                            <div id="cooked-items-container" class="mt-2 space-y-2"></div>
                            <button onclick="addCookedItemRow()" class="mt-2 text-sm font-semibold primary-text hover:text-[var(--primary-color-darker)]">+ Add Menu Item</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Raw Food Waste</h3>
                            <div id="waste-items-container" class="mt-2 space-y-2"></div>
                            <button onclick="addWasteItemRow()" class="mt-2 text-sm font-semibold primary-text hover:text-[var(--primary-color-darker)]">+ Add Waste Item</button>
                        </div>
                        <div class="text-center">
                            <button id="submitReportBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 w-full sm:w-auto">Submit Daily Report</button>
                            <p id="report-status" class="text-center mt-4 text-sm"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 modal-content scale-95">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Update Quantity</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <div class="mt-1 grid grid-cols-2 gap-2">
                        <button id="modal-type-in" onclick="setTransactionType('IN')" class="bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg">IN (Stock In)</button>
                        <button id="modal-type-out" onclick="setTransactionType('OUT')" class="bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg">OUT (Stock Out)</button>
                    </div>
                </div>
                <div>
                    <label for="modal-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <div class="flex items-center gap-2">
                        <input id="modal-quantity" type="number" placeholder="Enter quantity" class="mt-1 w-full p-3 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus">
                        <select id="modal-unit-select" class="w-32 mt-1 p-3 border rounded-lg focus:outline-none focus:ring-2 primary-ring-focus bg-gray-50"></select>
                    </div>
                </div>
            </div>
            <div id="modal-error" class="text-red-500 text-sm mt-4"></div>
            <div class="mt-6 flex justify-end gap-4">
                <button onclick="closeModal()" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button id="modal-submit-btn" class="bg-green-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-600 transition">Submit</button>
            </div>
        </div>
    </div>


    <script>
        // --- MOCK for LOCAL DEVELOPMENT ---
        if (typeof google === 'undefined') {
            console.log("Setting up mock 'google' object for local development.");
            window.google = {
                script: {
                    run: {
                        _mockData: { "Rice": { quantity: 50, unit: "kg" }, "Sugar": { quantity: 25, unit: "kg" }, "Lentils": { quantity: 15.5, unit: "kg" }},
                        _mockRecipes: { "Dal Fry": [{ name: "Lentils", quantity: 0.1, unit: "kg" }, { name: "Spices", quantity: 10, unit: "g" }] },
                        _mockConfig: { AppName: "Gurukul Test Kitchen", PrimaryColor: "#2563eb" },
                        withSuccessHandler: function(cb) { this._success = cb; return this; },
                        withFailureHandler: function(cb) { this._failure = cb; return this; },
                        getInitialData: function() {
                            if (this._success) setTimeout(() => this._success({inventory: this._mockData, recipes: this._mockRecipes, config: this._mockConfig }), 500);
                        },
                        addTransaction: function(itemName, type, quantity) {
                            if (type === 'IN') this._mockData[itemName].quantity += quantity; else this._mockData[itemName].quantity -= quantity;
                            if (this._success) setTimeout(() => this._success("Transaction successful."), 500);
                        },
                        addNewItem: function(name, unit) {
                             if (this._mockData[name]) { if (this._failure) setTimeout(() => this._failure({ message: `Item "${name}" already exists.` }), 500); return; }
                            this._mockData[name] = { quantity: 0, unit: unit };
                            if (this._success) setTimeout(() => this._success(`Successfully added "${name}".`), 500);
                        },
                        addRecipe: function(recipe) {
                             if (this._mockRecipes[recipe.name]) { if (this._failure) setTimeout(() => this._failure({ message: `Recipe "${recipe.name}" already exists.` }), 500); return; }
                            this._mockRecipes[recipe.name] = recipe.ingredients;
                            if (this._success) setTimeout(() => this._success("Recipe saved!"), 500);
                        },
                        logDailyUsage: function(reportData) {
                            console.log("MOCK: Logging daily usage", reportData);
                            if(this._success) setTimeout(() => this._success("Report logged successfully."), 500);
                        }
                    }
                }
            };
        }

        // --- GLOBAL STATE ---
        let masterInventoryData = {};
        let masterRecipeData = {};

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchInitialData();
            document.getElementById('report-date').valueAsDate = new Date();
        });

        function fetchInitialData() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(data => {
                    applyConfig(data.config);
                    displayInventory(data.inventory);
                    displayRecipes(data.recipes);
                    // Initialize forms if they are empty
                    if (document.getElementById('ingredients-container').children.length === 0) addIngredientRow();
                    if (document.getElementById('cooked-items-container').children.length === 0) addCookedItemRow();
                    if (document.getElementById('waste-items-container').children.length === 0) addWasteItemRow();
                })
                .withFailureHandler(showError)
                .getInitialData();
        }
        
        // --- CONFIG & THEME ---
        function applyConfig(config) {
            const appName = config.AppName || "Gurukul Inventory";
            const primaryColor = config.PrimaryColor || '#f97316';
            
            const darkenColor = (hex, percent) => {
                let r = parseInt(hex.substring(1, 3), 16), g = parseInt(hex.substring(3, 5), 16), b = parseInt(hex.substring(5, 7), 16);
                r = Math.min(255, Math.floor(r * (100 - percent) / 100));
                g = Math.min(255, Math.floor(g * (100 - percent) / 100));
                b = Math.min(255, Math.floor(b * (100 - percent) / 100));
                return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
            };
            const darkerColor = darkenColor(primaryColor, 10);

            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--primary-color-darker', darkerColor);

            document.title = `${appName} - Inventory Management`;
            document.getElementById('header-title').textContent = appName;
        }

        // --- TAB MANAGEMENT ---
        function changeTab(tabName) {
            ['inventory', 'menu', 'report'].forEach(tabId => {
                document.getElementById(`${tabId}-tab`).classList.add('hidden');
                document.querySelector(`button[onclick="changeTab('${tabId}')"]`).classList.remove('active');
                 document.querySelector(`button[onclick="changeTab('${tabId}')"]`).classList.add('text-gray-500');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            const button = document.querySelector(`button[onclick="changeTab('${tabName}')"]`);
            button.classList.add('active');
            button.classList.remove('text-gray-500');
        }

        // --- INVENTORY DISPLAY & MANAGEMENT ---
        function displayInventory(data) {
            masterInventoryData = data;
            const listEl = document.getElementById('inventory-list');
            listEl.innerHTML = '';
            if (Object.keys(data).length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 py-4">No inventory items. Add one below!</p>';
            } else {
                const header = `<div class="grid grid-cols-2 sm:grid-cols-3 gap-4 font-semibold text-gray-600 border-b pb-2 mb-2"><div class="sm:col-span-2">Item</div><div class="text-right">Current Stock</div></div>`;
                listEl.innerHTML = header;
                Object.keys(data).sort().forEach(name => {
                    const item = data[name];
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-2 sm:grid-cols-3 gap-4 items-center py-4 item-row cursor-pointer';
                    row.setAttribute('onclick', `openModal('${name}', '${item.unit}')`);
                    row.innerHTML = `<div class="sm:col-span-2 font-medium text-lg">${name}</div><div class="text-right text-xl font-bold">${item.quantity.toFixed(3)} <span class="text-sm text-gray-500">${item.unit}</span></div>`;
                    listEl.appendChild(row);
                });
            }
            showLoading(false);
        }

        // --- RECIPE DISPLAY & MANAGEMENT ---
        function displayRecipes(data) {
            masterRecipeData = data;
            const recipeListEl = document.getElementById('existing-recipes');
            recipeListEl.innerHTML = '';
            if (Object.keys(data).length === 0) {
                recipeListEl.innerHTML = '<p class="text-gray-500">No menu items defined yet.</p>';
            } else {
                 Object.keys(data).sort().forEach(name => {
                    const ingredients = data[name];
                    let ingredientsHtml = ingredients.map(ing => `${ing.name} (${ing.quantity} ${ing.unit})`).join(', ');
                    const recipeEl = document.createElement('div');
                    recipeEl.className = 'p-4 bg-gray-100 rounded-lg';
                    recipeEl.innerHTML = `<p class="font-semibold text-gray-800">${name}</p><p class="text-sm text-gray-600 mt-1">${ingredientsHtml}</p>`;
                    recipeListEl.appendChild(recipeEl);
                });
            }
        }
        
        function addIngredientRow() {
            const container = document.getElementById('ingredients-container');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 ingredient-row';
            row.innerHTML = `
                <input type="text" placeholder="Ingredient Name" class="flex-grow p-2 border rounded-lg ingredient-name bg-white">
                <input type="number" placeholder="Qty" class="w-24 p-2 border rounded-lg ingredient-quantity">
                <select class="w-24 p-2 border rounded-lg ingredient-unit bg-white">
                    <option value="kg">kg</option> <option value="g">g</option> <option value="pcs">pcs</option> <option value="litre">litre</option> <option value="ml">ml</option>
                </select>
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
            `;
            container.appendChild(row);
        }

        document.getElementById('saveRecipeBtn').addEventListener('click', () => {
            const name = document.getElementById('menu-item-name').value.trim();
            const statusEl = document.getElementById('recipe-status');
            const ingredients = Array.from(document.querySelectorAll('#ingredients-container .ingredient-row')).map(row => ({
                name: row.querySelector('.ingredient-name').value.trim(),
                quantity: parseFloat(row.querySelector('.ingredient-quantity').value),
                unit: row.querySelector('.ingredient-unit').value
            })).filter(ing => ing.name && ing.quantity > 0);

            if (!name || ingredients.length === 0) {
                statusEl.textContent = 'Please provide a menu name and at least one valid ingredient.'; statusEl.className = 'text-center mt-4 text-sm text-red-500'; return;
            }
            if (masterRecipeData[name]) {
                 statusEl.textContent = `Recipe "${name}" already exists.`; statusEl.className = 'text-center mt-4 text-sm text-red-500'; return;
            }

            const recipe = { name, ingredients };
            const btn = document.getElementById('saveRecipeBtn');
            btn.disabled = true; statusEl.textContent = `Saving "${name}"...`; statusEl.className = 'text-center mt-4 text-sm text-gray-500';
            
            // Optimistic update
            masterRecipeData[name] = ingredients;
            displayRecipes(masterRecipeData);
            document.getElementById('menu-item-name').value = '';
            document.getElementById('ingredients-container').innerHTML = '';
            addIngredientRow();

            google.script.run
                .withSuccessHandler(response => {
                    statusEl.textContent = response; statusEl.className = 'text-center mt-4 text-sm text-green-600';
                    btn.disabled = false;
                    setTimeout(() => { statusEl.textContent = ''; }, 3000);
                })
                .withFailureHandler(err => {
                    showError(err); statusEl.textContent = `Error: ${err.message}`; statusEl.className = "text-center mt-4 text-sm text-red-500";
                    // Revert optimistic update
                    delete masterRecipeData[name];
                    displayRecipes(masterRecipeData);
                    btn.disabled = false;
                })
                .addRecipe(recipe);
        });

        // --- DAILY REPORT SECTION ---
        function addCookedItemRow() {
            const container = document.getElementById('cooked-items-container');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 cooked-item-row';
            row.innerHTML = `
                <select class="flex-grow p-2 border rounded-lg menu-item-select bg-white"></select>
                <input type="number" placeholder="Servings Made" class="w-40 p-2 border rounded-lg servings-quantity">
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
            `;
            populateMenuItemSelect(row.querySelector('.menu-item-select'));
            container.appendChild(row);
        }

        function addWasteItemRow() {
            const container = document.getElementById('waste-items-container');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 waste-item-row';
            row.innerHTML = `
                <select class="flex-grow p-2 border rounded-lg waste-item-select bg-white"></select>
                <input type="number" placeholder="Qty Wasted" class="w-32 p-2 border rounded-lg waste-quantity">
                <span class="w-12 text-sm text-gray-600 waste-unit"></span>
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
            `;
            const selectEl = row.querySelector('.waste-item-select');
            populateInventoryItemSelect(selectEl);
             selectEl.addEventListener('change', () => {
                const unitSpan = row.querySelector('.waste-unit');
                const selectedItem = masterInventoryData[selectEl.value];
                unitSpan.textContent = selectedItem ? selectedItem.unit : '';
                if(selectedItem) row.querySelector('.waste-unit').textContent = selectedItem.unit;
            });
            container.appendChild(row);
        }

        document.getElementById('submitReportBtn').addEventListener('click', () => {
            const statusEl = document.getElementById('report-status');
            const reportData = {
                date: document.getElementById('report-date').value,
                meal: document.getElementById('report-meal').value,
                people: document.getElementById('report-people').value,
                cookedItems: Array.from(document.querySelectorAll('.cooked-item-row')).map(r => ({ name: r.querySelector('.menu-item-select').value, servings: parseFloat(r.querySelector('.servings-quantity').value) })).filter(i => i.name && i.servings > 0),
                wasteItems: Array.from(document.querySelectorAll('.waste-item-row')).map(r => ({ name: r.querySelector('.waste-item-select').value, quantity: parseFloat(r.querySelector('.waste-quantity').value) })).filter(i => i.name && i.quantity > 0)
            };
             reportData.wasteItems.forEach(item => item.unit = masterInventoryData[item.name].unit);

            if (!reportData.date || !reportData.people) { statusEl.textContent = "Please fill in Date and People Served."; statusEl.className = "text-center mt-4 text-sm text-red-500"; return; }
            if (reportData.cookedItems.length === 0 && reportData.wasteItems.length === 0) { statusEl.textContent = "Please add at least one cooked item or waste item."; statusEl.className = "text-center mt-4 text-sm text-red-500"; return; }
            
            const btn = document.getElementById('submitReportBtn');
            btn.disabled = true; statusEl.textContent = 'Submitting report...'; statusEl.className = "text-center mt-4 text-sm text-gray-500";
            
            // Clear form immediately for faster feedback
            document.getElementById('cooked-items-container').innerHTML = ''; addCookedItemRow();
            document.getElementById('waste-items-container').innerHTML = ''; addWasteItemRow();
            document.getElementById('report-people').value = '';

            google.script.run
                .withSuccessHandler(response => {
                    statusEl.textContent = response; statusEl.className = "text-center mt-4 text-sm text-green-600";
                    // Refresh data in the background
                    fetchInitialData(); 
                    setTimeout(() => { statusEl.textContent = ''; }, 4000);
                    btn.disabled = false;
                })
                .withFailureHandler(err => {
                    showError(err); statusEl.textContent = `Error: ${err.message}`; statusEl.className = "text-center mt-4 text-sm text-red-500";
                    btn.disabled = false;
                })
                .logDailyUsage(reportData);
        });

        // --- SELECT POPULATION UTILS ---
        function populateInventoryItemSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Select Ingredient...</option>';
            Object.keys(masterInventoryData).sort().forEach(name => selectElement.innerHTML += `<option value="${name}">${name}</option>`);
        }
        function populateMenuItemSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Select Menu Item...</option>';
            Object.keys(masterRecipeData).sort().forEach(name => selectElement.innerHTML += `<option value="${name}">${name}</option>`);
        }

        // --- UTILITIES (Modal, Add Item, Loading, Errors) ---
        let currentTransaction = {};
        function openModal(itemName, itemUnit) {
            currentTransaction = { itemName, itemUnit, type: null };
            document.getElementById('modal-title').textContent = `Update: ${itemName}`;
            const unitSelect = document.getElementById('modal-unit-select');
            unitSelect.innerHTML = (itemUnit.toLowerCase() === 'kg') ? `<option value="kg">kg</option><option value="g">g</option>` : `<option value="${itemUnit}">${itemUnit}</option>`;
            document.getElementById('modal-quantity').value = '';
            document.getElementById('modal-error').textContent = '';
            setTransactionType(null); // Reset buttons
            const modal = document.getElementById('transaction-modal');
            modal.classList.remove('hidden', 'opacity-0');
            modal.firstElementChild.classList.remove('scale-95');
        }
        function closeModal() {
            const modal = document.getElementById('transaction-modal');
            modal.classList.add('opacity-0');
            modal.firstElementChild.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        function setTransactionType(type) {
            currentTransaction.type = type;
            const inBtn = document.getElementById('modal-type-in');
            const outBtn = document.getElementById('modal-type-out');
            inBtn.className = type === 'IN' ? 'bg-green-500 text-white font-semibold py-3 rounded-lg' : 'bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg';
            outBtn.className = type === 'OUT' ? 'bg-red-500 text-white font-semibold py-3 rounded-lg' : 'bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg';
        }

        document.getElementById('modal-submit-btn').addEventListener('click', () => {
            const quantityInput = parseFloat(document.getElementById('modal-quantity').value);
            const selectedUnit = document.getElementById('modal-unit-select').value;
            const modalError = document.getElementById('modal-error');
            if (!currentTransaction.type) { modalError.textContent = 'Please select a transaction type (IN or OUT).'; return; }
            if (isNaN(quantityInput) || quantityInput <= 0) { modalError.textContent = 'Please enter a valid, positive quantity.'; return; }
            
            let quantityInBaseUnit = quantityInput;
            if (currentTransaction.itemUnit.toLowerCase() === 'kg' && selectedUnit.toLowerCase() === 'g') {
                quantityInBaseUnit = quantityInput / 1000;
            }
            
            const originalQuantity = masterInventoryData[currentTransaction.itemName].quantity;
            const submitBtn = document.getElementById('modal-submit-btn');
            submitBtn.disabled = true; modalError.textContent = '';
            
            // Optimistic Update
            if(currentTransaction.type === 'IN') {
                masterInventoryData[currentTransaction.itemName].quantity += quantityInBaseUnit;
            } else {
                masterInventoryData[currentTransaction.itemName].quantity -= quantityInBaseUnit;
            }
            displayInventory(masterInventoryData);
            closeModal();
            
            // Background Sync
            google.script.run
                .withSuccessHandler(() => {
                    submitBtn.disabled = false;
                })
                .withFailureHandler(err => {
                    // Revert on failure
                    masterInventoryData[currentTransaction.itemName].quantity = originalQuantity;
                    displayInventory(masterInventoryData);
                    showError(err);
                    submitBtn.disabled = false;
                })
                .addTransaction(currentTransaction.itemName, currentTransaction.type, quantityInBaseUnit);
        });

        document.getElementById('addItemBtn').addEventListener('click', () => {
            const name = document.getElementById('newItemName').value.trim();
            const unit = document.getElementById('newItemUnit').value;
            const statusEl = document.getElementById('add-item-status');

            if (!name) { statusEl.textContent = "Please enter an item name."; statusEl.className = "text-center mt-4 text-sm text-red-500"; return; }
            if (masterInventoryData[name]) { statusEl.textContent = `Item "${name}" already exists.`; statusEl.className = "text-center mt-4 text-sm text-red-500"; return; }

            const btn = document.getElementById('addItemBtn');
            btn.disabled = true;
            statusEl.textContent = `Adding "${name}"...`;
            statusEl.className = "text-center mt-4 text-sm text-gray-500";
            
            // Optimistic UI Update
            masterInventoryData[name] = { quantity: 0, unit: unit };
            displayInventory(masterInventoryData);
            document.getElementById('newItemName').value = '';

            // Background Sync
            google.script.run
                .withSuccessHandler((successMessage) => {
                    statusEl.textContent = successMessage;
                    statusEl.className = "text-center mt-4 text-sm text-green-600";
                    setTimeout(() => { statusEl.textContent = ''; }, 3000);
                    btn.disabled = false;
                })
                .withFailureHandler(error => {
                    showError(error);
                    statusEl.textContent = `Error: ${error.message}`;
                    statusEl.className = "text-center mt-4 text-sm text-red-500";
                    // Revert the optimistic update
                    delete masterInventoryData[name];
                    displayInventory(masterInventoryData);
                    btn.disabled = false;
                })
                .addNewItem(name, unit);
        });

        function showLoading(isLoading) {
            document.getElementById('loading').classList.toggle('hidden', !isLoading);
            if(!isLoading) {
                 document.getElementById('inventory-list').classList.remove('hidden');
            }
        }
        function showError(error) {
            console.error('Google Apps Script Error:', error);
            document.getElementById('loading').classList.add('hidden');
            const errorEl = document.getElementById('error');
            errorEl.classList.remove('hidden');
            errorEl.firstElementChild.textContent = `Error: ${error.message}. Please check the console and try again.`;
        }

    </script>

</body>
</html>

